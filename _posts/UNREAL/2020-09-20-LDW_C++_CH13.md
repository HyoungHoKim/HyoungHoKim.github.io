---
layout: post
title:  "이득우 C++ Chapter13"
date:   2020-09-20 22:15:34 +0900
categories: [UNREAL]
---

이득우의 언리얼 C++ 게임 개발의 정석의 Chapter13 요약입니다.

### 프로젝트의 정리와 모듈 추가
- 언리얼 소스 코드의 구조를 살펴보면 언리얼 오브젝트에 관련된 헤더들은 Classes 폴더를 사용하고, 외부에 공개되는 선언 파일은 Public 폴더에서, 외부에 공개하지 않은 정의 파일은 Private 폴더에서 보관하고 있다.
- 언리얼 엔진은 주 게임 모듈을 사용해 게임 프로젝트의 로직을 관리한다. 우리가 지금까지 작업한 코드는 ArenaBattle이라는 주 게임 모듈에서 관리하고 있었다. 그런데 주 게임 모듈 외에 다른 모듈을 게임 프로젝트에 추가하고 로직을 분리해 관리할 수도 있다.
- 언리얼 에디터는 C++프로젝트를 생성할 때 주 게임 모듈을 자동으로 생성해주지만, 추가 모듈을 생성하는 기능은 제공하지 않는다. 새로운 모듈을 추가하려면 언리얼 빌드 규칙을 이해하고, 이에 따라 폴더와 파일을 생성해야 한다. 추가 모듈 제작을 위해 필요한 요소는 다음과 같다.
    - 모듈 폴더와 빌드 설정 파일 : 모듈 폴더와 모듈명으로 Build.cs 파일
    - 모듈의 정의 파일 : 모듈명으로 된 .cpp파일
- 비주얼 스튜디오에 추가한 모듈을 빌드하도록 프로젝트이름.Target.cs 파일과 프로젝트이름Editor.Target.cs 파일 정보를 수정해야한다. 각 Target.cs 파일은 게임 빌드와 에디터 빌드 설정을 지정해준다.
- 새로운 DLL 파일이 생성됐다면 언리얼 에디터가 이 DLL 파일을 로딩하도록 명령하는 일이 남았다. 이를 위해 uproject 파일에 새로운 모듈에 대한 정보를 기입해야 한다.
- 모듈 정보를 기입할 때 새로운 LDW_CPlusSetting 모듈을 다른 모듈보다 먼저 로딩하도록 LoadingPhase 값을 "PreDefault"로 설정하고 LDW_CPlus모듈이 LDW_CPlusSetting모듈에 대해 의존성을 가지도록 설정한다. 그러면 LDW_CPlusSetting 모듈은 이제부터 항상 LDW_CPlus 모듈보다 먼저 언리얼 에디터 프로세스에 올라간다.

### INI 설정과 애셋의 지연 로딩
- 새로운 모듈에 추가한 ABCharacterSetting은 앞으로 사용할 캐릭터 애셋의 목록을 보관한다.
- 생성자 코드에 캐릭터 애셋을 코드로 지정할 수 있지만, 만일 애셋이 변경되면 코드를 다시 만들고 컴파일해야하는 번거로움이 있다. 언리얼 엔진은 언리얼 오브젝트의 기본값을 유연하게 관리하도록 외부 INI파일에서 기본 속성값을 지정하는 기능을 제공한다.
- 애셋은 경로 정보만 알면 프로그램에서 이를 참조해 로딩할 수 있다. 이 애셋 경로 정보를 보관하기 위해 언리얼 엔진은 FSoftObjectPath라는 클래스를 제공한다.
- 언리얼 오브젝트가 기본값을 INI 파일에서 불러들이려면 UClass 매크로에 config 키워드를 추가해 여기에 불러드릴 INI 파일의 이름을 지정하고, 불러드릴 PROPERTY속성에는 config키워드를 선언해야한다. 이렇게 선언하면 언리얼 엔진은 언리얼 오브젝트를 초기화 할 때 해당 속성의 값을 INI 파일에서 읽어 설정한다.
- UCLASS 매크로 내 config 키워드에 있는 LDW_CPlus라는 설정으로 인해, 언리얼 엔진은 초기화 단계에서 Config 폴더에 위치한 DefaultLDW_CPlus.ini 파일을 읽어들여 ABCharacterSetting의 CharacterAssets값을 설정한다.
- 언리얼 엔진이 초기화되면 엔진 구동에 필요한 모듈이 순차적으로 로딩된다. 모듈이 로딩되면서 모듈은 자신에게 속한 모든 언리얼 오브젝트의 기본값을 지정해 생성해내는데, 이를 클래스 기본 객체(Class Default Object)라고 한다. 그래서 엔진이 초기화되면 모든 언리얼 오브젝트 클래스 기본 객체가 메모리에 올라간 상태가 된다.
- 이렇게 메모리에 올라간 클래스의 기본 객체는 GetDefault함수를 사용해 가져올 수 있다. 클래스 기본 객체는 엔진이 종료될 때까지 상주하기 때문에 언제든지 사용해도 된다.
- 언리얼 엔진은 게임 진행 중에도 비동기 방식으로 애셋을 로딩하도록 FStreamableManager라는 클래스를 제공한다. 이 매니저 클래스는 프로젝트에서 하나만 활성화 하는 것이 좋기 때문에 우리 프로젝트에서는 유일한 인스턴스로 동작하는 ABInstance 클래스에서 이를 멤버변수로 선언한다.
- FStreamableManager에서 비동기 방식으로 애셋을 로딩하는 명령은 AsyncLoad다. 해당 함수에 FStreamableDelegate 형식의 델리게이트를 넘겨줄 경우, 애셋이 로딩을 완료하면 해당 델리게이트에 연결된 함수를 호출해준다. FStreamable형식으로 델리게이트 멤버를 선언하고 넘겨줄 수 있지만 델리게이트에서 제공하는 CreateUObject 명령을 사용해 즉석에서 델리게이트를 생성함으로써 함수와 연동시킨 후 넘겨주는 방식이 간편하다.

### 무한 맵의 생성
- 섹션 액터가 해야할 일은 다음과 같다.
    - 섹션의 배경과 네 방향으로 캐릭터의 입장을 통제하는 문을 제공한다.
    - 플레이어가 섹션에 진입하면 모든 문을 닫는다.
    - 문을 닫고 일정 시간 후에 섹션 중앙에 NPC를 생성한다.
    - 문을 닫고 일정 시간 후에 아이템 상자를 섹션 내 랜덤한 위치에 생성한다.
    - 생성한 NPC가 죽으면 모든 문을 개방한다.
    - 통과한 문으로 이어지는 새로운 섹션을 생성한다.
- 액터에는 에디터와 연동되는 OnConstruction이라는 특별한 함수가 설계돼 있다. 이 함수를 생성하고, 여기서 액터와 컴포넌트 속성을 설정하면 작업 중인 레벨에서도 미리 결과를 확인할 수 있다. 
