---
layout: post
title:  "이득우 C++ Chapter11"
date:   2020-09-09 15:16:58 +0900
categories: [UNREAL]
---

이득우의 언리얼 C++ 게임 개발의 정석의 Chapter11 요약입니다.

### 엑셀 데이터의 활용
- 캐릭터 스텟 데이터는 게임의 기반을 이루는 변하지 않는 데이터이므로 보통 게임 앱이 초기화 될 때 불러들인다. 언리얼 엔진은 게임 앱을 관리하기 위한 용도로 게임 인스턴스라는 언리얼 오브젝트를 제공한다. 이 게임 인스턴스가 캐릭터의 스탯을 관리하도록 설계하면 게임 앱이 초기화될 때 캐릭터 스탯 데이터를 불러들이고, 게임 앱이 종료될 때까지 캐릭터 스탯 데이터는 보존된다.
- 게임 인스턴스가 게임 앱을 관리하기 위해서는 프로젝트 세팅의 맵&모드 탭에 있는 GameInstance 항목을 변경해야한다.
- 게임을 시작하는 것은 생각보다 복잡한 로직을 거친다.
    1. 게임 앱의 초기화(UGameInstance::Init)
    2. 레벨에 속한 액터의 초기화(AActor::PostInitializeComponents)
    3. 플레이어의 로그인(AGameMode::PostLogin)
    4. 게임의 시작(AGameMode::StartPlay, AActor::BeginPlay)
- csv파일을 언리얼 엔진에 불러들이기 위해 테이블 데이터의 각 열의 이름과 유형이 동일한 구조체를 선언해야 합니다. 언리얼 엔진에서 제공하는 FTableRowBase 구조체를 상속받은 FABCharacterData라는 이름의 구조체를 게임 인스턴스 헤더에 선언한다.
- 구조체를 생성할 때 언리얼이 지정한 규칙에 따라줘야 에디터 인터페이스에서 연동해 사용할 수 있다. 언리얼 오브젝트와 유사하게 USTRUCT 매크로를 구조체 선언 윗줄에 넣고 구조체 내부에는 GENERATED_BODY() 매크로를 선언한다.
- 구조체의 골격을 완성하면 CSV파일의 각 열의 이름과 동일한 멤버변수를 타입에 맞춰 선언한다. 이때 테이블의 첫번째 위치한 Name 열 데이터는 언리얼 엔진ㅇ에서 자동으로 키 값으로 사용하기 때문에 Name열의 선언은 제외한다.
- 언리얼 엔진은 해당 테이블 데이터를 관리하도록 DataTable이라는 언리얼 오브젝트를 제공한다.

### 액터 컴포넌트의 제작
- 새로운 액터 클래스를 생성하고 이를 캐릭터에 부착해 캐릭터 스탯에 대한 관리를 액터 컴포넌트가 일임하도록 기능을 구현해본다.
- 액터 컴포넌트를 생성하면 자동으로 제공되는 템플릿 코드에는 BeginPlay와 TickComponent 함수가 제공된다.
- 언리얼 오브젝트에는 직렬화(Serialization)기능이 있어서 오브젝트의 UPROPERTY 속성을 저장하고 로딩할 수 있다. 하지만 컴포넌트 스탯 중 CurrentHP 값은 게임을 시작할 때 마다 변경되므로 이 값을 보관하는 것은 의미가 없고 오히려 오브젝트를 저장할 때 필요 없는 디스크 공간만 차지한다. 이러한 속성에는 Transient 키워드를 추가해 해당 속성을 직렬화에서 제외시키는 것이 좋다.

### 캐릭터 위젯 UI제작

### 모듈과 빌드 설정
- 언리얼 엔진은 액터에 UI 위젯을 부착할 수 있도록 UWidgetComponent라는 클래스를 제공한다. 해당 기능을 사용하려면 프로젝트이름.Build.cs파일에 "UMG"를 추가해야한다.
- 언리얼 빌드 툴에 의해 UMG 모듈의 헤더 파일 경로로 별도의 설정 없이 바로 사용할 수 있도록 기본 경로로 설정된다.

### UI와 데이터의 연동
- UI의 로직은 애님 인스턴스와 유사하게 C++클래스에서 미리 만들어 제공할 수 있는데, 위젯 블루프린트가 사용하는 기반 C++클래스는 UserWidget이다.
- 언리얼 오브젝트의 약 포인터 선언은 TWeakObjectPtr을 사용한다. 우리가 사용하는 캐릭터 위젯은 캐릭터와 생사를 같이하기 때문에 약 포인터의 사용은 필요없지만, 만약 UI와 캐릭터가 서로 다른 액터라면 약 포인터를 사용하는 것이 바람직하다.
- 책에서는 UI 시스템 생성을 PostInitializeComponents에서 해주었지만 4.22버전 이후로 위젯 클래스 생성은 BeginPlay에서 이루어진다. 따라서 BeginPlay보다 먼저 실행되는 PostInitializeComponents에서 위젯을 생성하면 nullptr이 뜬다.
- 위젯 블루프린트에서 이름 설정하는 것에 유의하자...
