---
layout: post
title:  "이득우 C++ Chapter12"
date:   2020-09-14 17:02:58 +0900
categories: [UNREAL]
---

이득우의 언리얼 C++ 게임 개발의 정석의 Chapter12 요약입니다.

### AIController와 내비게이션 시스템
- 플레이어가 조종하지 않지만 레벨에 배치돼 스스로 행동하는 캐릭터를 NPC(Non Player Character)라고 한다.
- 언리얼 엔진은 컴퓨터가 인공지능(AI)으로 NPC를 제어하도록 AI 컨트롤러를 제공한다.
- 폰은 플레이어 컨트롤러와 동일한 방식으로 AI 컨트롤러에 빙의될 수 있으며, 이때부터는 AI가 시키는 대로 행동한다.
- NPC는 스스로 움직여야 하기 때문에 이를 보조할 장치가 필요한데, 이때 많이 사용하는 것이 내비게이션 메시기반의 길 찾기 시스템이다. 로직을 구현하기 전에 먼저 레벨에 내비게이션 메시를 배치해 NPC가 스스로 움직일 수 있는 환경을 구축해야 한다.
- 뷰포트를 누르고 P를 누르면 빌드한 내비 메시 영역이 녹색으로 뷰표트에 표시된다.
- 언리얼 내비게이션 시스템은 이동 가능한 목적지를 랜덤으로 가져오는 GetRandomPointInNavigableRadius 함수와 목적지로 폰을 이동시키는 SimpleMoveToLocation 함수를 제공한다. 이들을 이용해 구현한 코드는 다음과 같다.
- NavigationSystem 모듈이 추가됐고 이를 지정해야한다.
- NavigationSystem -> NavigationSystemV1
- 구현부에 NavigationSystem.h 헤더를 추가해야한다.
- SimpleMoveToLocation 함수는 블루프린터 라이브러리로 이동됐다.
- Possess/UnPossess -> OnPossess/OnUnPossess

### 비헤이비어 트리 시스템
- 좀 더 복잡한 NPC의 행동 패턴을 구현하려면 체계적인 모델에서 설계하는 것이 바람직하다.
- 언리얼 엔진은 비헤이비어 트리 모델과 이를 편집하는 에디터를 자체적으로 탑재하고 있으므로 이를 사용하면 AI 컨트롤러가 수행해야 하는 행동 패턴을 체계적으로 설계할 수 있다.
- 비헤이비어 트리는 NPC가 해야할 행동을 분석하고 우선순위가 높은 행동부터 NPC가 실행할 수 있도록 트리 구조로 설계하는 기법이다.
- 블랙보드 : 블랙보드는 인공지능 판단에 사용하는 데이터 집합을 의미한다. NPC의 의사결정은 블랙보드에 있는 데이터를 기반으로 진행된다.
- 비헤이비어 트리 : 블랙보드 데이터에 기반해 설계한 비헤이비어 트리의 정보를 저장한 에셋이다. 언리얼 에디터에서는 비헤이비어 트리를 시각화해 저장할 수 있도록 편집기능을 제공한다.
- 태스크(명령, 행동)은 독립적으로 실행될 수 없고 반드시 컴포짓 노드를 거쳐 실행돼야 한다.
- 컴포짓 노드에는 대표적으로 셀렉터와 시퀀스가 있다.  
    - 시퀀스 컴포짓 : 연결된 테스크들이 False 결과가 나올 때까지 왼쪽에서 오른쪽으로 태스크를 계속 실행한다.
- C++ 코드에서 비헤이비어 트리 관련 기능을 사용하려면 설정에서 AIModule 모듈을 추가해야한다.
- 비헤이비어 트리는 태스크를 실행할 때 태스크 클래스의 ExecuteTask라는 멤버함수를 실행한다. ExecuteTask 함수는 다음의 셋 중 하나의 값을 반환해야 한다.
    - Aborted : 태스크 실행 중에 중단됐다. 결과적으로 실패했다.
    - Failed : 태스크를 수행했지만 실패했다.
    - Succeeded : 태스크를 성공적으로 수행했다.
    - InProgress : 태스크를 계속 수행하고 있다. 태스크의 실행 결과는 향후 알려줄 예정이다.
- ExecuteTask 함수의 실행 결과에 따라 컴포짓 내에 있는 다음 태스크를 수행할지, 중단할지 결정된다.
- 현재 사용 중인 시퀀스 컴포짓은 자신에 속한 태스크를 실패할 때까지 계속 실행하는 성질을 가진다.
- 태스크의 이름을 다른 이름으로 표시하고 싶다면 NodeName 속성을 다른 값으로 지정하면 된다.

### NPC의 추격 기능 구현
- Object 타입에서는 기반 클래스를 지정할 수 있는데, 기반 클래스는 ABCharacter로 지정한다.
- NPC의 행동 패턴은 플레이어를 발견했는지, 발견하지 못했는지에 따라 추격과 정찰로 구분된다. 추격과 정찰 중에 하나를 선택해 행동하기 때문에 이번에는 셀렉터 컴포짓을 사용해 로직을 확장하는 것이 적합하다. 추격과 정찰 중 추격에 더 우선권을 주고, 추격 로직은 블랙보드의 Target을 향해 이동하도록 비헤이비어 트리 설계를 확장해본다.
- 비헤이비어 트리의 서비스 노드는 자신이 속한 컴포짓 노드가 활성화될 경우 주기적으로 TickNode 함수를 호출한다. 호출하는 주기는 서비스 노드 내부에 설정된 Interval 속성값으로 지정할 수 있다.
- 반경 내에 다른 NPC ABCharacter가 있는 경우도 가정해 반경 내에 모든 캐릭터를 감지하는 OverlapMultiByChannel 함수를 사용한다. 반경 내에 감지된 모든 캐릭터 정보는 목록을 관리하는데 적합한 언리얼 엔진 자료구조인 TArray로 전달된다.

### NPC 공격
